(import x86_64)

(assert (= (x86_64/memq :base 'rax)
           {:kind :mem :size 8 :base 'rax}))
(assert (= (x86_64/memd :base 'rax)
           {:kind :mem :size 4 :base 'rax}))
(assert (= (x86_64/memw :base 'rax)
           {:kind :mem :size 2 :base 'rax}))
(assert (= (x86_64/memb :base 'rax)
           {:kind :mem :size 1 :base 'rax}))

(assert (throws? '(x86_64 . "unsupported mem size in mov: 4")
                 (x86_64/encode-instruction '(mov rax (memd :base rbx)))))
(assert (throws? '(x86_64 . "size is implicit in memq/memd/memw/memb")
                 (x86_64/encode-instruction '(mov rax (memq :size 8 :base rbx)))))

(def expected-instruction-encodings
  '(((nop) [0x90])
    ((mov rax 0x12) [0x48 0xC7 0xC0 0x12 0x00 0x00 0x00])
    ((mov rcx 0x1234) [0x48 0xC7 0xC1 0x34 0x12 0x00 0x00])
    ((mov rdx 0x123456) [0x48 0xC7 0xC2 0x56 0x34 0x12 0x00])
    ((mov rbx 0x12345678) [0x48 0xC7 0xC3 0x78 0x56 0x34 0x12])
    ((mov rsp 0x12) [0x48 0xC7 0xC4 0x12 0x00 0x00 0x00])
    ((mov rbp 0x1234) [0x48 0xC7 0xC5 0x34 0x12 0x00 0x00])
    ((mov rsi 0x123456) [0x48 0xC7 0xC6 0x56 0x34 0x12 0x00])
    ((mov rdi 0x12345678) [0x48 0xC7 0xC7 0x78 0x56 0x34 0x12])
    ((mov r8 0x12) [0x49 0xC7 0xC0 0x12 0x00 0x00 0x00])
    ((mov r9 0x1234) [0x49 0xC7 0xC1 0x34 0x12 0x00 0x00])
    ((mov r10 0x123456) [0x49 0xC7 0xC2 0x56 0x34 0x12 0x00])
    ((mov r11 0x12345678) [0x49 0xC7 0xC3 0x78 0x56 0x34 0x12])
    ((mov r12 0x12) [0x49 0xC7 0xC4 0x12 0x00 0x00 0x00])
    ((mov r13 0x1234) [0x49 0xC7 0xC5 0x34 0x12 0x00 0x00])
    ((mov r14 0x123456) [0x49 0xC7 0xC6 0x56 0x34 0x12 0x00])
    ((mov r15 0x12345678) [0x49 0xC7 0xC7 0x78 0x56 0x34 0x12])
    ((mov rax rbx) [0x48 0x8B 0xC3])
    ((mov rax (mem :size 8 :base rbx)) [0x48 0x8B 0x03])
    ((mov (mem :size 8 :base rbx) rax) [0x48 0x89 0x03])
    ((mov rax (memq :base rbp)) [0x48 0x8B 0x45 0x00])
    ((mov rax (memq :base r12)) [0x49 0x8B 0x04 0x24])
    ((mov rax (memq :base rbx :disp 0x12)) [0x48 0x8B 0x43 0x12])
    ((mov rax (memq :base rbx :disp 0x12345678)) [0x48 0x8B 0x83 0x78 0x56 0x34 0x12])
    ((mov rax (memq :base rbx :index rcx :scale 4)) [0x48 0x8B 0x04 0x8B])
    ((mov rax (memq :base rbx :index r9 :scale 8 :disp 0x20)) [0x4A 0x8B 0x44 0xCB 0x20])
    ((mov rax (memq :index rcx :scale 2 :disp 0x12345678)) [0x48 0x8B 0x04 0x4D 0x78 0x56 0x34 0x12])
    ((mov rax (memq :rip 0x12345678)) [0x48 0x8B 0x05 0x78 0x56 0x34 0x12])
    ((mov rax (memq :disp 0x12345678)) [0x48 0x8B 0x04 0x25 0x78 0x56 0x34 0x12])
    ((mov (memq :base r11 :disp 0x12) rax) [0x49 0x89 0x43 0x12])
    ((mov (memq :base rbx :index rcx :scale 4 :disp 0x1234) r8)
     [0x4C 0x89 0x84 0x8B 0x34 0x12 0x00 0x00])
    ((add rbx 0x12345678) [0x48 0x81 0xC3 0x78 0x56 0x34 0x12])
    ((or rbx 0x12345678) [0x48 0x81 0xCB 0x78 0x56 0x34 0x12])
    ((adc rbx 0x12345678) [0x48 0x81 0xD3 0x78 0x56 0x34 0x12])
    ((sbb rbx 0x12345678) [0x48 0x81 0xDB 0x78 0x56 0x34 0x12])
    ((and rbx 0x12345678) [0x48 0x81 0xE3 0x78 0x56 0x34 0x12])
    ((sub rbx 0x12345678) [0x48 0x81 0xEB 0x78 0x56 0x34 0x12])
    ((xor rbx 0x12345678) [0x48 0x81 0xF3 0x78 0x56 0x34 0x12])
    ((cmp rbx 0x12345678) [0x48 0x81 0xFB 0x78 0x56 0x34 0x12])
    ((test rbx 0x12345678) [0x48 0xF7 0xC3 0x78 0x56 0x34 0x12])
    ((add r11 0x12345678) [0x49 0x81 0xC3 0x78 0x56 0x34 0x12])
    ((test r11 0x12345678) [0x49 0xF7 0xC3 0x78 0x56 0x34 0x12])
    ((rol rbx 0x12) [0x48 0xC1 0xC3 0x12])
    ((ror rbx 0x34) [0x48 0xC1 0xCB 0x34])
    ((rcl rbx 0x56) [0x48 0xC1 0xD3 0x56])
    ((rcr rbx 0x78) [0x48 0xC1 0xDB 0x78])
    ((shl rbx 0x9A) [0x48 0xC1 0xE3 0x9A])
    ((sal rbx 0xBC) [0x48 0xC1 0xE3 0xBC])
    ((shr rbx 0xDE) [0x48 0xC1 0xEB 0xDE])
    ((sar rbx 0xF0) [0x48 0xC1 0xFB 0xF0])
    ((rol r11 0x12) [0x49 0xC1 0xC3 0x12])
    ((bt rbx 0x12) [0x48 0x0F 0xBA 0xE3 0x12])
    ((bts rbx 0x34) [0x48 0x0F 0xBA 0xEB 0x34])
    ((btr rbx 0x56) [0x48 0x0F 0xBA 0xF3 0x56])
    ((btc rbx 0x78) [0x48 0x0F 0xBA 0xFB 0x78])
    ((bt r11 0x12) [0x49 0x0F 0xBA 0xE3 0x12])))

(for [[instruction expected-encoding] expected-instruction-encodings]
  (let [actual-encoding (catch [e (throw (cons 'x86_64
                                                (str "encode failed for "
                                                     instruction
                                                     ": "
                                                     e)))]
                          (x86_64/encode-instruction instruction))]
    (assert (= actual-encoding expected-encoding))))
