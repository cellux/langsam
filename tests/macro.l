(let [m (macro m [x] `(+ ,x 1))
      w (macro w [y] `(m (* ,y 2)))
      z 5]
  (assert (macro? m))
  (assert (macro-form? '(m 3)))
  (assert (= (repr m) "<Macro:m>"))
  (assert (= (:body m) '((quasiquote (+ (unquote x) 1)))))
  (assert (= (m (* z 3)) 16))
  (assert (= (w (* z 3)) 31))
  (assert (= (macroexpand-1 '(m (* z 3))) '(+ (* z 3) 1)))
  (assert (= (macroexpand-1 '(w (* z 3))) '(m (* (* z 3) 2))))
  (assert (= (macroexpand '(m (* z 3))) '(+ (* z 3) 1)))
  (assert (= (macroexpand '(w (* z 3))) '(+ (* (* z 3) 2) 1)))
  (assert (= (macroexpand-all '(m (* z 3))) '(+ (* z 3) 1)))
  (assert (= (macroexpand-all '(w (* z 3))) '(+ (* (* z 3) 2) 1)))
  (assert (= (macroexpand-all '(w (* z (m 3)))) '(+ (* (* z (+ 3 1)) 2) 1))))

(let [m (macro m [x] x)
      w (macro w [x] `(m ,x))]
  (assert (= (macroexpand-all 'a) 'a))
  (assert (= (macroexpand '(m 12)) 12))
  (assert (= (macroexpand '(w 12)) 12))
  (assert (= (macroexpand-all '(w 12)) 12))
  (assert (= (macroexpand-all '(m (w 5))) 5))
  (assert (= (macroexpand-all '(w (m 5))) 5))
  (assert (= (macroexpand-all '[:a (w 5)]) '[:a 5]))
  (assert (= (macroexpand-all '(:a . (w 3))) '(:a w 3)))
  (assert (= (macroexpand-all '((w 3) . :a)) '(3 . :a)))
  (assert (= (macroexpand-all '(:a (w 3))) '(:a 3)))
  (assert (= (macroexpand-all '((w 3) :a)) '(3 :a)))
  (assert (= (macroexpand-all '{(w 3) :a (w 8) b}) '{3 :a 8 b}))
  (assert (= (macroexpand-all '{:a (w 3) b (w 8)}) '{:a 3 b 8}))
  (assert (= (macroexpand-all ''(:a (w 3)) ''(:a (w 3)))))
  (assert (= (macroexpand-all ''(:a ,(w 3)) ''(:a ,(w 3)))))
  (assert (= (macroexpand-all '`(:a (w 3)) ''(:a (w 3)))))
  (assert (= (macroexpand-all '`(:a ,(w 3)) ''(:a 3))))
  (assert (= (macroexpand-all '`(:a ,@(w [1 (w :b) 3])) ''(:a 1 :b 3))))
  (assert (= (macroexpand-all '`(:a ,@(w [1 (w . :b) 3])) ''(:a 1 (w . :b) 3))))
  (assert (= (macroexpand-all '`(:a ,@(w [1 (w . (w :b)) 3])) ''(:a 1 (w . :b) 3))))
  (assert (= (macroexpand-all '`(:a ,@(w [1 ((w :a) . :b) 3])) ''(:a 1 (:a . :b) 3))))
  (assert (= (macroexpand-all '`(:a ,@(w [1 ((w :a) . (w :b)) 3])) ''(:a 1 (:a . :b) 3))))
  (assert (= (macroexpand-all '`m) '`m))
  (assert (= (macroexpand-all '`(m 1)) '`(m 1)))
  (assert (= (macroexpand-all '`(+ ,x 1)) '`(+ ,x 1)))
  (assert (= (macroexpand-all '(`(+ ,x 1))) '(`(+ ,x 1))))
  (assert (= (macroexpand-all '`(if 5 (throw '(foo . "bar"))) '`(if 5 (throw '(foo . "bar")))))))

(let [m (macro [] `(throw '(syntax . "foo")))]
  (assert (= (macroexpand-1 '(m)) '(throw '(syntax . "foo"))))
  (assert (= (macroexpand '(m)) '(throw '(syntax . "foo"))))
  (assert (= (macroexpand-all '(m)) '(throw '(syntax . "foo")))))
